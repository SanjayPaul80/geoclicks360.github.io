<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GeoClicks CRM</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- Login/Signup Section -->
  <div id="authSection" class="flex flex-col items-center justify-center min-h-screen">
    <div class="bg-white p-6 rounded shadow-md w-full max-w-sm">
      <h2 class="text-xl font-bold mb-4 text-center">GeoClicks CRM Login</h2>
      <input type="email" id="email" placeholder="Email" class="w-full p-2 border mb-3 rounded" />
      <input type="password" id="password" placeholder="Password" class="w-full p-2 border mb-3 rounded" />
      <div class="flex justify-between">
        <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded w-[48%]">Login</button>
        <button id="signupBtn" class="bg-gray-600 text-white px-4 py-2 rounded w-[48%]">Sign Up</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="hidden p-4 max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Your Contacts</h2>
      <button id="logoutBtn" class="text-red-600 font-semibold">Logout</button>
    </div>

    <form id="contactForm" class="grid gap-4 bg-white p-4 rounded shadow mb-6">
      <input type="hidden" id="contactId" />
      <input type="text" id="name" placeholder="Name" required class="p-2 border rounded" />
      <input type="email" id="cemail" placeholder="Email" required class="p-2 border rounded" />
      <input type="tel" id="phone" placeholder="Phone" class="p-2 border rounded" />
      <textarea id="notes" placeholder="Notes" class="p-2 border rounded"></textarea>
      <button type="submit" class="bg-blue-600 text-white py-2 rounded">Save Contact</button>
    </form>

    <div id="contactsList" class="space-y-4"></div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDxlQ8JHgovDHbbAD6PtgplFfJgapgGHg4",
      authDomain: "geoclickscrm.firebaseapp.com",
      databaseURL: "https://geoclickscrm-default-rtdb.firebaseio.com",
      projectId: "geoclickscrm",
      storageBucket: "geoclickscrm.firebasestorage.app",
      messagingSenderId: "566444677680",
      appId: "1:566444677680:web:8de72fcdef63c22d88abf5",
      measurementId: "G-KH7HPN5HE1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authSection = document.getElementById("authSection");
    const dashboard = document.getElementById("dashboard");

    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    loginBtn.onclick = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
    };

    signupBtn.onclick = () => {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      createUserWithEmailAndPassword(auth, email, password).catch(err => alert(err.message));
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
      if (user) {
        authSection.classList.add("hidden");
        dashboard.classList.remove("hidden");
        loadContacts(user.uid);
      } else {
        authSection.classList.remove("hidden");
        dashboard.classList.add("hidden");
      }
    });

    // Contact form logic
    const contactForm = document.getElementById("contactForm");
    const contactsList = document.getElementById("contactsList");

    function loadContacts(uid) {
      const ref = collection(db, "users", uid, "contacts");
      onSnapshot(ref, snap => {
        contactsList.innerHTML = "";
        snap.forEach(docSnap => {
          const contact = docSnap.data();
          const div = document.createElement("div");
          div.className = "bg-white p-4 rounded shadow";

          div.innerHTML = `
            <p><strong>Name:</strong> ${contact.name}</p>
            <p><strong>Email:</strong> ${contact.email}</p>
            <p><strong>Phone:</strong> ${contact.phone || ""}</p>
            <p><strong>Notes:</strong> ${contact.notes || ""}</p>
            <button class="text-blue-600 font-semibold editBtn" data-id="${docSnap.id}">Edit</button>
            <button class="text-red-600 font-semibold ml-4 deleteBtn" data-id="${docSnap.id}">Delete</button>
          `;

          contactsList.appendChild(div);
        });

        document.querySelectorAll(".editBtn").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ref = doc(db, "users", auth.currentUser.uid, "contacts", id);
            const snap = await getDocs(collection(db, "users", auth.currentUser.uid, "contacts"));
            snap.forEach(s => {
              if (s.id === id) {
                document.getElementById("contactId").value = id;
                document.getElementById("name").value = s.data().name;
                document.getElementById("cemail").value = s.data().email;
                document.getElementById("phone").value = s.data().phone || "";
                document.getElementById("notes").value = s.data().notes || "";
              }
            });
          };
        });

        document.querySelectorAll(".deleteBtn").forEach(btn => {
          btn.onclick = async () => {
            const id = btn.dataset.id;
            const ref = doc(db, "users", auth.currentUser.uid, "contacts", id);
            await deleteDoc(ref);
          };
        });
      });
    }

    contactForm.onsubmit = async e => {
      e.preventDefault();
      const id = document.getElementById("contactId").value;
      const data = {
        name: document.getElementById("name").value,
        email: document.getElementById("cemail").value,
        phone: document.getElementById("phone").value,
        notes: document.getElementById("notes").value
      };

      const uid = auth.currentUser.uid;
      if (id) {
        const ref = doc(db, "users", uid, "contacts", id);
        await updateDoc(ref, data);
      } else {
        await addDoc(collection(db, "users", uid, "contacts"), data);
      }

      contactForm.reset();
      document.getElementById("contactId").value = "";
    };
  </script>
</body>
</html>
